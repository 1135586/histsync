{% extends "base.html" %}

{% block content %}
<div class="container">
    <h2>Profile of {{username}}</h2>
    {% if current_user.name == username %}
      <button class="btn btn-primary" id="show-api-key">Show API Key</button>
      <button class="btn btn-primary" id="hide-api-key" style="display: none;">Hide API Key</button>
      <button class="btn btn-primary" id="regenerate-api-key">Generate new API Key</button>
      <div id="api-key" style="display: none;">
        <p><b>API key: </b><span id="api-key-value">{{current_user.api_key}}</span></p>
        <p><b>Command to add to your .bashrc :</b> export PROMPT_COMMAND='histsync-client.py  --api_key {{current_user.api_key}} --user {{current_user.name}}  "`history 1`"'</p>
      </div>
    {% endif %}
    <table class="table">
    <caption>Commands!</caption>
    <thead>
      <tr>
        <th>#</th>
        <th>Another ID</th>
        <th>User</th>
        <th>Added</th>
        <th>Command</th>
        <th>Is Public?</th>
        <th>Controls</th>
      </tr>
    </thead>
    <tbody>
      {% for c in commands %}
      <tr id="command-row-{{c.id}}">
        <th scope="row">{{loop.index}}</th>
        <td>{{c.another_id}}</td>
        <td>{{c.user.name}}</td>
        <td>{{c.format_time_added()}}</td>
        <td>{{c.text}}</td>
        <td>{{c.is_public}}</td>
        <td>
          <button type="button" class="btn btn-default btn-sm btn-remove-command" data-command-id="{{c.id}}">
            <span class="glyphicon glyphicon-remove"></span>
          </button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}

{% block scripts %}
{{super()}}
<script>
  $( document ).ready(function() {
    $("#show-api-key").click(function() {
      $("#show-api-key").hide();
      $("#hide-api-key").show();
      $("#api-key").show();
    });
    $("#hide-api-key").click(function() {
      $("#show-api-key").show();
      $("#hide-api-key").hide();
      $("#api-key").hide();
    });
    $("#regenerate-api-key").click(function() {
      $.ajax("/_regenerate_api_key").done(function(data){
        $('#api-key-value').html(data.api_key)
      });
    });
    $(".btn-remove-command").click(function() {
      var command_id = $(this).data('command-id');
      var that = this;
      $(that).hide();
      $.post("/_delete_command/" + command_id).done(function(done){
        $("#command-row-" + command_id).remove();
      }).fail(function() {
        $(that).show();
      });
    });
  });
</script>
{% endblock %}
